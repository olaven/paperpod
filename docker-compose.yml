version: "3"
services:
  gateway:
    build: .
    env_file:
      - .env
    command: yarn gateway dev
    ports:
      - $GATEWAY_PORT:$GATEWAY_PORT
    volumes:
      - .:/paperpod
    environment:
      - PORT=$GATEWAY_PORT
      - GATEWAY_HTTP_PORT=$GATEWAY_HTTP_PORT
      - WEB_PORT=$WEB_PORT
      - DOCS_PORT=$DOCS_PORT
      - API_PORT=$API_PORT
      - AUTHENTICATION_PORT=$AUTHENTICATION_PORT
    working_dir: /paperpod
  api:
    build:
      context: .
      dockerfile: ./packages/api/Dockerfile
    env_file:
      - .env
    command: yarn api dev
    volumes:
      - .:/paperpod
    environment:
      PORT: $API_PORT
      JWT_SECRET: $JWT_SECRET
      PGHOST: database
      PGDATABASE: $PGDATABASE
      PGUSER: $PGUSER
      PGOPTIONS: "-c search_path='api'"
      PGPASSWORD: $PGPASSWORD
      AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
      AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    working_dir: /paperpod
  authentication:
    build: .
    env_file:
      - .env
    command: yarn authentication dev
    volumes:
      - .:/paperpod
    environment:
      PORT: $AUTHENTICATION_PORT
      JWT_SECRET: $JWT_SECRET
      PGHOST: database
      PGOPTIONS: "-c search_path='authentication'"
      PGDATABASE: $PGDATABASE
      PGUSER: $PGUSER
      PGPASSWORD: $PGPASSWORD
    working_dir: /paperpod
  web:
    build: .
    env_file:
      - .env
    command: yarn web dev
    volumes:
      - .:/paperpod
    working_dir: /paperpod

  docs: 
    build: . 
    env_file: 
      - .env 
    command: yarn docs dev 
    volumes:
      - .:/paperpod
    environment: 
      - PORT=$DOCS_PORT
    working_dir: /paperpod

  database:
    image: postgres:13
    ports: 
      - 5433:5432
    environment:
      - POSTGRES_DB=$PGDATABASE
      - POSTGRES_USER=$PGUSER
      - POSTGRES_PASSWORD=$PGPASSWORD


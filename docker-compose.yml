version: "3"
services:
  ## PACKAGES

  gateway:
    build: .
    env_file:
      - .env
    command: yarn gateway dev
    ports:
      - $GATEWAY_PORT:$GATEWAY_PORT
    volumes: # Sync everything but node modules
      - .:/paperpod
      - /paperpod/node_modules
      - /paperpod/packages/gateway/node_modules
    environment:
      - PORT=$GATEWAY_PORT
      - WEB_PORT=$WEB_PORT
      - API_PORT=$API_PORT
      - AUTHENTICATION_PORT=$AUTHENTICATION_PORT
    working_dir: /paperpod
  api:
    build: .
    env_file:
      - .env
    command: yarn api dev
    volumes: # Sync everything but node modules
      - /paperpod/node_modules
      - /paperpod/packages/api/node_modules
      - .:/paperpod
    environment:
      - PORT=$API_PORT
      - MONGODB_NAME=$MONGODB_NAME
      - MONGODB_USERNAME=$MONGODB_USERNAME
      - MONGODB_PASSWORD=$MONGODB_PASSWORD
      - MONGODB_HOST=database_api
      - MONGODB_PORT=$MONGODB_PORT #always true: https://hub.docker.com/_/mongo
    working_dir: /paperpod
  converter:
    build: .
    env_file:
      - .env
    command: yarn converter dev
    volumes: # Sync everything but node modules
      - .:/paperpod
      - /paperpod/node_modules
      - /paperpod/packages/converter/node_module
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS
  authentication:
    build: .
    env_file:
      - .env # workaround to solve issues with node_modules being compiled on mac
    command: yarn authentication dev #bash -c "npm rebuild bcrypt --build-from-source && yarn authentication dev"
    volumes: # Sync everything but node modules
      - .:/paperpod
      - /paperpod/node_modules
      - /paperpod/packages/authentication/node_modules
    environment:
      - PORT=$AUTHENTICATION_PORT
      - MONGODB_NAME=$MONGODB_NAME
      - MONGODB_USERNAME=$MONGODB_USERNAME
      - MONGODB_PASSWORD=$MONGODB_PASSWORD
      - MONGODB_HOST=database_authentication
      - MONGODB_PORT=$MONGODB_PORT #always true: https://hub.docker.com/_/mongo
    working_dir: /paperpod
  web:
    build: .
    env_file:
      - .env
    command: yarn web dev
    volumes: # Sync everything but node modules
      - .:/paperpod
      - /paperpod/node_modules
      - /paperpod/packages/web/node_module
    working_dir: /paperpod

  ## DATABASES

  database_authentication:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGODB_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD=$MONGODB_PASSWORD

  database_api:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGODB_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD=$MONGODB_PASSWORD
